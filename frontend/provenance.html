<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Diamond Provenance | Diamond Auth Block</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <nav>
     <ul>
        <li><a href="index.html" class="active">Home</a></li>
        <li><a href="entityInterfaceNew.html">Register Entity</a></li>
        <li><a href="provenance.html">Diamond Provenance</a></li>
      </ul>
    </nav>
  </aside>

  
  <div class="logo-floating">
    <img src="assets/logo.png" alt="Logo" />
  </div>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Register Raw Diamond -->
    <section class="form-section">
      <h2>Register Raw Diamond (Miners)</h2>
      <form id="registerRawDiamondForm">
        <div class="form-row">
          <label for="origin">Origin</label>
          <input type="text" id="origin" required />
        </div>
        <div class="form-row">
          <label for="extractionDate">Extraction Date (Unix Timestamp)</label>
          <input type="number" id="extractionDate" required />
        </div>
        <div class="form-row">
          <label for="weight">Weight (carats)</label>
          <input type="number" id="weight" step="0.01" required />
        </div>
        <div class="form-row">
          <label for="characteristics">Characteristics</label>
          <input type="text" id="characteristics" required />
        </div>
        <button type="submit" class="cta-button">Register Diamond</button>
      </form>
    </section>

    <!-- Process Diamond -->
    <section class="form-section">
      <h2>Process Diamond (Manufacturers)</h2>
      <form id="processDiamondForm">
        <div class="form-row">
          <label for="rawDiamondId">Raw Diamond ID</label>
          <input type="number" id="rawDiamondId" required />
        </div>
        <div class="form-row">
          <label for="processedWeight">New Weight (carats)</label>
          <input type="number" id="processedWeight" step="0.01" required />
        </div>
        <div class="form-row">
          <label for="processedCharacteristics">New Characteristics</label>
          <input type="text" id="processedCharacteristics" required />
        </div>
        <button type="submit" class="cta-button">Process Diamond</button>
      </form>
    </section>

    <!-- Certify Diamond -->
    <section class="form-section">
      <h2>Certify Diamond (Certifiers)</h2>
      <form id="certifyDiamondForm">
        <div class="form-row">
          <label for="certifyDiamondId">Diamond ID</label>
          <input type="number" id="certifyDiamondId" required />
        </div>
        <div class="form-row">
          <label for="certificationId">Certification ID</label>
          <input type="text" id="certificationId" required />
        </div>
        <button type="submit" class="cta-button">Certify</button>
      </form>
    </section>

    <!-- Transfer Diamond -->
    <section class="form-section">
      <h2>Transfer Diamond</h2>
      <form id="transferDiamondForm">
        <div class="form-row">
          <label for="transferDiamondId">Diamond ID</label>
          <input type="number" id="transferDiamondId" required />
        </div>
        <div class="form-row">
          <label for="recipientAddress">Recipient Address</label>
          <input type="text" id="recipientAddress" placeholder="0x..." required />
        </div>
        <button type="submit" class="cta-button">Transfer</button>
      </form>
    </section>

    <!-- Status Output -->
    <div id="statusMessage" class="status-message hidden"></div>
  </main>

<script src="provenance.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>
<script>
  window.onload = async function () {
    const provenanceContractAddress = "";
    const entityContractAddress = "";
    const provenanceABI = [];
    const entityABI = [];

    let provider;
    let signer;
    let contract;
    let entityContract;

    const connectWalletBtn = document.getElementById("connectWalletBtn");
    const accountAddressSpan = document.getElementById("accountAddress");
    const networkNameSpan = document.getElementById("networkName");
    const statusMessageDiv = document.getElementById("statusMessage");

    const registerForm = document.getElementById("registerDiamondForm");
    const processForm = document.getElementById("processDiamondForm");
    const certifyForm = document.getElementById("certifyDiamondForm");
    const transferForm = document.getElementById("transferDiamondForm");

    function showStatus(msg, isError = false) {
      statusMessageDiv.textContent = msg;
      statusMessageDiv.className = isError ? "status-error" : "status-success";
      statusMessageDiv.classList.remove("hidden");
      console.log(msg);
    }

    function hideAllForms() {
      registerForm?.classList.add("hidden");
      processForm?.classList.add("hidden");
      certifyForm?.classList.add("hidden");
      transferForm?.classList.add("hidden");
    }

    async function connectWallet() {
      if (!window.ethereum) return showStatus("MetaMask not found.", true);

      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        contract = new ethers.Contract(provenanceContractAddress, provenanceABI, signer);
        entityContract = new ethers.Contract(entityContractAddress, entityABI, signer);

        const address = await signer.getAddress();
        accountAddressSpan.textContent = address;

        const network = await provider.getNetwork();
        networkNameSpan.textContent = `${network.name} (Chain ID: ${network.chainId})`;

        const [, , isRegistered, , role] = await entityContract.getEntityInfo(address);

        if (!isRegistered) {
          showStatus("Not registered in the EntityContract. Please register first.", true);
          return;
        }

        showStatus(`Connected as ${role}`);
        hideAllForms();
        switch (role) {
          case "Miner":
            registerForm?.classList.remove("hidden");
            break;
          case "Manufacturer":
            processForm?.classList.remove("hidden");
            break;
          case "Certifier":
            certifyForm?.classList.remove("hidden");
            break;
          case "Retailer":
            transferForm?.classList.remove("hidden");
            break;
        }
      } catch (err) {
        showStatus("Wallet connection failed: " + err.message, true);
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      const origin = document.getElementById("origin").value;
      const date = parseInt(document.getElementById("extractionDate").value);
      const weight = parseFloat(document.getElementById("weight").value);
      const characteristics = document.getElementById("characteristics").value;
      try {
        const tx = await contract.registerRawDiamond(origin, date, weight, characteristics);
        await tx.wait();
        showStatus("Raw diamond registered!");
      } catch (err) {
        showStatus("Register failed: " + err.message, true);
      }
    }

    async function handleProcess(event) {
      event.preventDefault();
      const rawId = document.getElementById("rawDiamondId").value;
      const weight = parseFloat(document.getElementById("processedWeight").value);
      const characteristics = document.getElementById("processedCharacteristics").value;
      try {
        const tx = await contract.processDiamond(rawId, weight, characteristics);
        await tx.wait();
        showStatus("Diamond processed!");
      } catch (err) {
        showStatus("Process failed: " + err.message, true);
      }
    }

    async function handleCertify(event) {
      event.preventDefault();
      const certId = document.getElementById("certifyDiamondId").value;
      const certNum = document.getElementById("certificationId").value;
      try {
        const tx = await contract.certifyDiamond(certId, certNum);
        await tx.wait();
        showStatus("Diamond certified!");
      } catch (err) {
        showStatus("Certification failed: " + err.message, true);
      }
    }

    async function handleTransfer(event) {
      event.preventDefault();
      const transferId = document.getElementById("transferDiamondId").value;
      const toAddress = document.getElementById("recipientAddress").value;
      try {
        const tx = await contract.transferDiamond(transferId, toAddress);
        await tx.wait();
        showStatus("Diamond transferred!");
      } catch (err) {
        showStatus("Transfer failed: " + err.message, true);
      }
    }

    connectWalletBtn.addEventListener("click", connectWallet);
    registerForm?.addEventListener("submit", handleRegister);
    processForm?.addEventListener("submit", handleProcess);
    certifyForm?.addEventListener("submit", handleCertify);
    transferForm?.addEventListener("submit", handleTransfer);
  };
</script>


</body>
</html>

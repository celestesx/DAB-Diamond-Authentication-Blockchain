<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Diamond Provenance | Diamond Auth Block</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <nav>
     <ul>
        <li><a href="index.html" class="active">Home</a></li>
        <li><a href="entityInterfaceNew.html">Register Entity</a></li>
        <li><a href="provenance.html">Diamond Provenance</a></li>
      </ul>
    </nav>
  </aside>

  
  <div class="logo-floating">
    <img src="assets/logo.png" alt="Logo" />
  </div>



  <!-- Main Content -->
  <main class="main-container">

     <section class="form-section" id="walletStatus">
    <h2>Wallet Status</h2>
    <button id="connectWalletBtn" class="cta-button">Connect Wallet</button>
    <div class="wallet-info">
      <p><strong>Connected Account:</strong> <span id="accountAddress">Not Connected</span></p>
      <p><strong>Network:</strong> <span id="networkName">Not Connected</span></p>
    </div>
  </section>

    <!-- Register Raw Diamond -->
    <section class="form-section">
      <h2>Register Raw Diamond (Miners)</h2>
      <form id="registerRawDiamondForm">
        <div class="form-row">
          <label for="origin">Origin</label>
          <input type="text" id="origin" required />
        </div>
        <div class="form-row">
          <label for="extractionDate">Extraction Date (Unix Timestamp)</label>
          <input type="number" id="extractionDate" required />
        </div>
        <div class="form-row">
          <label for="weight">Weight (carats)</label>
          <input type="number" id="weight" step="0.01" required />
        </div>
        <div class="form-row">
          <label for="characteristics">Characteristics</label>
          <input type="text" id="characteristics" required />
        </div>
        <button type="submit" class="cta-button">Register Diamond</button>
      </form>
    </section>

    <!-- Process Diamond -->
    <section class="form-section">
      <h2>Process Diamond (Manufacturers)</h2>
      <form id="processDiamondForm">
        <div class="form-row">
          <label for="rawDiamondId">Raw Diamond ID</label>
          <input type="number" id="rawDiamondId" required />
        </div>
        <div class="form-row">
          <label for="processedWeight">New Weight (carats)</label>
          <input type="number" id="processedWeight" step="0.01" required />
        </div>
        <div class="form-row">
          <label for="processedCharacteristics">New Characteristics</label>
          <input type="text" id="processedCharacteristics" required />
        </div>
        <button type="submit" class="cta-button">Process Diamond</button>
      </form>
    </section>

    <!-- Certify Diamond -->
    <section class="form-section">
      <h2>Certify Diamond (Certifiers)</h2>
      <form id="certifyDiamondForm">
        <div class="form-row">
          <label for="certifyDiamondId">Diamond ID</label>
          <input type="number" id="certifyDiamondId" required />
        </div>
        <div class="form-row">
          <label for="certificationId">Certification ID</label>
          <input type="text" id="certificationId" required />
        </div>
        <button type="submit" class="cta-button">Certify</button>
      </form>
    </section>

    <!-- Transfer Diamond -->
    <section class="form-section">
      <h2>Transfer Diamond</h2>
      <form id="transferDiamondForm">
        <div class="form-row">
          <label for="transferDiamondId">Diamond ID</label>
          <input type="number" id="transferDiamondId" required />
        </div>
        <div class="form-row">
          <label for="recipientAddress">Recipient Address</label>
          <input type="text" id="recipientAddress" placeholder="0x..." required />
        </div>
        <button type="submit" class="cta-button">Transfer</button>
      </form>
    </section>

    <!-- Status Output -->
    <div id="statusMessage" class="status-message hidden"></div>
  </main>


<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>
<script>
  window.onload = async function () {
    const statusMessageDiv = document.getElementById("statusMessage");
    function showStatus(msg, isError = false) {
      statusMessageDiv.textContent = msg;
      statusMessageDiv.className = isError ? "status-error" : "status-success";
      statusMessageDiv.classList.remove("hidden");
      console.log(msg);
    }

    function clearStatus() {
      statusMessageDiv.textContent = "";
      statusMessageDiv.classList.add("hidden");
    }

    const provenanceContractAddress = "0x69cB786e5d8747A22b28051616aA58875baf7C8d";
    const entityContractAddress = "0x69cB786e5d8747A22b28051616aA58875baf7C8d";
    const entityContractABI = [
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: "address",
                name: "entityAddress",
                type: "address",
              },
              {
                indexed: false,
                internalType: "string",
                name: "name",
                type: "string",
              },
              {
                indexed: false,
                internalType: "string",
                name: "role",
                type: "string",
              },
              {
                indexed: false,
                internalType: "string",
                name: "licenseNumber",
                type: "string",
              },
            ],
            name: "EntityRegistered",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: false,
                internalType: "string",
                name: "name",
                type: "string",
              },
              {
                indexed: false,
                internalType: "string",
                name: "location",
                type: "string",
              },
              {
                indexed: false,
                internalType: "string",
                name: "reason",
                type: "string",
              },
            ],
            name: "RegistrationRejected",
            type: "event",
          },
          {
            inputs: [
              { internalType: "string", name: "_name", type: "string" },
              { internalType: "string", name: "_location", type: "string" },
              { internalType: "string", name: "_role", type: "string" },
              {
                internalType: "string",
                name: "_licenseNumber",
                type: "string",
              },
            ],
            name: "registerEntity",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "_entityAddress",
                type: "address",
              },
            ],
            name: "getEntityInfo",
            outputs: [
              { internalType: "string", name: "name", type: "string" },
              { internalType: "string", name: "location", type: "string" },
              { internalType: "bool", name: "isRegistered", type: "bool" },
              { internalType: "string", name: "licenseNumber", type: "string" },
              { internalType: "string", name: "role", type: "string" },
            ],
            stateMutability: "view",
            type: "function",
          },
          {
            
            inputs: [{ internalType: "string", name: "_role", type: "string" }],
            name: "getEntitiesByRole",
            outputs: [
              { internalType: "address[]", name: "", type: "address[]" },
            ],
            stateMutability: "view",
            type: "function",
          },
          {
            
            inputs: [
              { internalType: "address", name: "_from", type: "address" },
              { internalType: "address", name: "_to", type: "address" },
            ],
            name: "isValidTransfer",
            outputs: [{ internalType: "bool", name: "", type: "bool" }],
            stateMutability: "nonpayable", 
            type: "function",
          },
          {
            // Added validateTransfer for completeness
            inputs: [
              { internalType: "address", name: "_from", type: "address" },
              { internalType: "address", name: "_to", type: "address" },
            ],
            name: "validateTransfer",
            outputs: [{ internalType: "bool", name: "", type: "bool" }],
            stateMutability: "view",
            type: "function",
          },
          // Add other functions/events from your ABI if needed
        ];
    const provenanceABI = [
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "entityContractAddress",
              "type": "address"
            }
          ],
          "stateMutability": "nonpayable",
          "type": "constructor"
        },
        {
          "inputs": [],
          "name": "ERC721EnumerableForbiddenBatchMint",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "sender",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            },
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            }
          ],
          "name": "ERC721IncorrectOwner",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "operator",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "ERC721InsufficientApproval",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "approver",
              "type": "address"
            }
          ],
          "name": "ERC721InvalidApprover",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "operator",
              "type": "address"
            }
          ],
          "name": "ERC721InvalidOperator",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            }
          ],
          "name": "ERC721InvalidOwner",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "receiver",
              "type": "address"
            }
          ],
          "name": "ERC721InvalidReceiver",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "sender",
              "type": "address"
            }
          ],
          "name": "ERC721InvalidSender",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "ERC721NonexistentToken",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "index",
              "type": "uint256"
            }
          ],
          "name": "ERC721OutOfBoundsIndex",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            }
          ],
          "name": "OwnableInvalidOwner",
          "type": "error"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "account",
              "type": "address"
            }
          ],
          "name": "OwnableUnauthorizedAccount",
          "type": "error"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "owner",
              "type": "address"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "approved",
              "type": "address"
            },
            {
              "indexed": true,
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "Approval",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "owner",
              "type": "address"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "operator",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "bool",
              "name": "approved",
              "type": "bool"
            }
          ],
          "name": "ApprovalForAll",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "certificationId",
              "type": "string"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "certifier",
              "type": "address"
            }
          ],
          "name": "DiamondCertified",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "uint256",
              "name": "rawDiamondId",
              "type": "uint256"
            },
            {
              "indexed": true,
              "internalType": "uint256",
              "name": "newDiamondId",
              "type": "uint256"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "manufacturer",
              "type": "address"
            }
          ],
          "name": "DiamondProcessed",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "miner",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "origin",
              "type": "string"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "weight",
              "type": "uint256"
            }
          ],
          "name": "DiamondRegistered",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "from",
              "type": "address"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "to",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "transferType",
              "type": "string"
            }
          ],
          "name": "DiamondTransferred",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "record",
              "type": "string"
            }
          ],
          "name": "HistoryRecordAdded",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "previousOwner",
              "type": "address"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "newOwner",
              "type": "address"
            }
          ],
          "name": "OwnershipTransferred",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "from",
              "type": "address"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "to",
              "type": "address"
            },
            {
              "indexed": true,
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "Transfer",
          "type": "event"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "to",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "approve",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            }
          ],
          "name": "balanceOf",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            },
            {
              "internalType": "string",
              "name": "certificationId",
              "type": "string"
            }
          ],
          "name": "certifyDiamond",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "getApproved",
          "outputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            }
          ],
          "name": "getDiamondBasicInfo",
          "outputs": [
            {
              "internalType": "string",
              "name": "origin",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "extractionDate",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "weight",
              "type": "uint256"
            },
            {
              "internalType": "string",
              "name": "characteristics",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            }
          ],
          "name": "getDiamondCertInfo",
          "outputs": [
            {
              "internalType": "bool",
              "name": "isCertified",
              "type": "bool"
            },
            {
              "internalType": "string",
              "name": "certificationId",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "rawDiamondId",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            }
          ],
          "name": "getDiamondHistory",
          "outputs": [
            {
              "internalType": "string[]",
              "name": "",
              "type": "string[]"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            }
          ],
          "name": "getDiamondOwnershipInfo",
          "outputs": [
            {
              "internalType": "address",
              "name": "currentOwner",
              "type": "address"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "rawDiamondId",
              "type": "uint256"
            }
          ],
          "name": "getProcessedDiamonds",
          "outputs": [
            {
              "internalType": "uint256[]",
              "name": "",
              "type": "uint256[]"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "account",
              "type": "address"
            },
            {
              "internalType": "string",
              "name": "role",
              "type": "string"
            }
          ],
          "name": "hasRole",
          "outputs": [
            {
              "internalType": "bool",
              "name": "",
              "type": "bool"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "operator",
              "type": "address"
            }
          ],
          "name": "isApprovedForAll",
          "outputs": [
            {
              "internalType": "bool",
              "name": "",
              "type": "bool"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "name",
          "outputs": [
            {
              "internalType": "string",
              "name": "",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "owner",
          "outputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "ownerOf",
          "outputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "rawDiamondId",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "weight",
              "type": "uint256"
            },
            {
              "internalType": "string",
              "name": "characteristics",
              "type": "string"
            }
          ],
          "name": "processDiamond",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "origin",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "extractionDate",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "weight",
              "type": "uint256"
            },
            {
              "internalType": "string",
              "name": "characteristics",
              "type": "string"
            }
          ],
          "name": "registerRawDiamond",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "renounceOwnership",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "from",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "to",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "safeTransferFrom",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "from",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "to",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            },
            {
              "internalType": "bytes",
              "name": "data",
              "type": "bytes"
            }
          ],
          "name": "safeTransferFrom",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "operator",
              "type": "address"
            },
            {
              "internalType": "bool",
              "name": "approved",
              "type": "bool"
            }
          ],
          "name": "setApprovalForAll",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "bytes4",
              "name": "interfaceId",
              "type": "bytes4"
            }
          ],
          "name": "supportsInterface",
          "outputs": [
            {
              "internalType": "bool",
              "name": "",
              "type": "bool"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "symbol",
          "outputs": [
            {
              "internalType": "string",
              "name": "",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "index",
              "type": "uint256"
            }
          ],
          "name": "tokenByIndex",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "index",
              "type": "uint256"
            }
          ],
          "name": "tokenOfOwnerByIndex",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "tokenURI",
          "outputs": [
            {
              "internalType": "string",
              "name": "",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "totalSupply",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "diamondId",
              "type": "uint256"
            },
            {
              "internalType": "address",
              "name": "to",
              "type": "address"
            }
          ],
          "name": "transferDiamond",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "from",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "to",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "tokenId",
              "type": "uint256"
            }
          ],
          "name": "transferFrom",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "newOwner",
              "type": "address"
            }
          ],
          "name": "transferOwnership",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        }
      ];
    const entityABI = [
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "entityAddress",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "name",
              "type": "string"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "role",
              "type": "string"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "licenseNumber",
              "type": "string"
            }
          ],
          "name": "EntityRegistered",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": false,
              "internalType": "string",
              "name": "name",
              "type": "string"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "location",
              "type": "string"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "reason",
              "type": "string"
            }
          ],
          "name": "RegistrationRejected",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": false,
              "internalType": "address",
              "name": "from",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "address",
              "name": "to",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "bool",
              "name": "isValid",
              "type": "bool"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "message",
              "type": "string"
            }
          ],
          "name": "TransferValidation",
          "type": "event"
        },
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "_role",
              "type": "string"
            }
          ],
          "name": "getEntitiesByRole",
          "outputs": [
            {
              "internalType": "address[]",
              "name": "",
              "type": "address[]"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "_entityAddress",
              "type": "address"
            }
          ],
          "name": "getEntityInfo",
          "outputs": [
            {
              "internalType": "string",
              "name": "name",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "location",
              "type": "string"
            },
            {
              "internalType": "bool",
              "name": "isRegistered",
              "type": "bool"
            },
            {
              "internalType": "string",
              "name": "licenseNumber",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "role",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "_from",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "_to",
              "type": "address"
            }
          ],
          "name": "isValidTransfer",
          "outputs": [
            {
              "internalType": "bool",
              "name": "",
              "type": "bool"
            }
          ],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "_name",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "_location",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "_role",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "_licenseNumber",
              "type": "string"
            }
          ],
          "name": "registerEntity",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "_from",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "_to",
              "type": "address"
            }
          ],
          "name": "validateTransfer",
          "outputs": [
            {
              "internalType": "bool",
              "name": "",
              "type": "bool"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        }
      ];

    let provider;
    let signer;
    let contract;
    let entityContract;

    const connectWalletBtn = document.getElementById("connectWalletBtn");
    const accountAddressSpan = document.getElementById("accountAddress");
    const networkNameSpan = document.getElementById("networkName");
    const registerForm = document.getElementById("registerRawDiamondForm");

    const processForm = document.getElementById("processDiamondForm");
    const certifyForm = document.getElementById("certifyDiamondForm");
    const transferForm = document.getElementById("transferDiamondForm");

 

    function hideAllForms() {
      registerForm?.classList.add("hidden");
      processForm?.classList.add("hidden");
      certifyForm?.classList.add("hidden");
      transferForm?.classList.add("hidden");
    }

    async function connectWallet() {
      try {
        if (!window.ethereum) return showStatus("MetaMask not found.", true);

        await window.ethereum.request({ method: "eth_requestAccounts" });

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();

        const address = await signer.getAddress();
        accountAddressSpan.textContent = address;

        if (!ethers.utils.isAddress(address)) {
          showStatus("Invalid Ethereum address.", true);
          return;
        }

        // Connect to contracts
        contract = new ethers.Contract(provenanceContractAddress, provenanceABI, signer);
        entityContract = new ethers.Contract(entityContractAddress, entityContractABI, signer);

        const [, , isRegistered, , role] = await entityContract.getEntityInfo(address);

        const network = await provider.getNetwork();
        networkNameSpan.textContent = `${network.name} (Chain ID: ${network.chainId})`;

        if (!isRegistered) {
          showStatus("Not registered in the EntityContract. Please register first.", true);
          return;
        }

        showStatus(`Connected as ${role}`);
        hideAllForms();

        switch (role) {
          case "Miner":
            registerForm?.classList.remove("hidden");
            break;
          case "Manufacturer":
            processForm?.classList.remove("hidden");
            break;
          case "Certifier":
            certifyForm?.classList.remove("hidden");
            break;
          case "Retailer":
            transferForm?.classList.remove("hidden");
            break;
        }
      } catch (err) {
        console.error(err);
        showStatus("Wallet connection failed: " + err.message, true);
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      clearStatus();

      if (!contract) return showStatus("Contract not loaded.", true);

      const origin = document.getElementById("origin").value;
      const extractionDate = parseInt(document.getElementById("extractionDate").value);
      const weight = parseFloat(document.getElementById("weight").value);
      const characteristics = document.getElementById("characteristics").value;

      if (!origin || !extractionDate || !weight || !characteristics) {
        return showStatus("All fields are required.", true);
      }

      try {
        showStatus("Sending transaction...");
        const tx = await contract.registerRawDiamond(origin, extractionDate, weight, characteristics);
        showStatus(`Transaction sent: ${tx.hash}`);
        await tx.wait();
        showStatus("Diamond registered successfully.");
        registerForm.reset();
      } catch (err) {
        console.error(err);
        showStatus("Registration failed: " + (err.reason || err.message || err), true);
      }
    }

    // Auto reconnect if accounts exist
    const accounts = await window.ethereum.request({ method: "eth_accounts" });
    if (accounts.length > 0) connectWallet();

    // Event Listeners
    connectWalletBtn.addEventListener("click", connectWallet);
    registerForm?.addEventListener("submit", handleRegister);
  };
</script> 


</body>
</html>
